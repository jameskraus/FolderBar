#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

skip_build=0
skip_test=0
skip_swiftlint=0
skip_swiftformat=0

if [[ "${FOLDERBAR_SKIP_CI:-}" == "1" ]]; then
  skip_build=1
  skip_test=1
fi

if [[ "${FOLDERBAR_SKIP_LINT:-}" == "1" ]]; then
  skip_swiftlint=1
  skip_swiftformat=1
fi

if [[ "${FOLDERBAR_SKIP_BUILD:-}" == "1" || "${SKIP_SWIFTBUILD:-}" == "1" ]]; then
  skip_build=1
fi

if [[ "${FOLDERBAR_SKIP_TESTS:-}" == "1" || "${SKIP_SWIFTTEST:-}" == "1" ]]; then
  skip_test=1
fi

if [[ "${SKIP_SWIFTLINT:-}" == "1" ]]; then
  skip_swiftlint=1
fi

if [[ "${SKIP_SWIFTFORMAT:-}" == "1" || "${FOLDERBAR_SKIP_FORMAT:-}" == "1" ]]; then
  skip_swiftformat=1
fi

if [[ "$skip_build" == "1" && "$skip_test" == "1" && "$skip_swiftlint" == "1" && "$skip_swiftformat" == "1" ]]; then
  exit 0
fi

if [[ "$skip_swiftformat" == "0" ]] && ! command -v swiftformat >/dev/null 2>&1; then
  echo "SwiftFormat is required for pre-push format checks but was not found on PATH." >&2
  echo "Install: brew install swiftformat" >&2
  echo "Skip once: SKIP_SWIFTFORMAT=1 git push (or git push --no-verify)" >&2
  exit 1
fi

if [[ "$skip_swiftlint" == "0" ]] && ! command -v swiftlint >/dev/null 2>&1; then
  echo "SwiftLint is required for pre-push linting but was not found on PATH." >&2
  echo "Install: brew install swiftlint" >&2
  echo "Skip once: SKIP_SWIFTLINT=1 git push (or git push --no-verify)" >&2
  exit 1
fi

if [[ "$skip_build" == "0" && "$skip_test" == "0" && "$skip_swiftlint" == "0" && "$skip_swiftformat" == "0" ]]; then
  make ci
  exit 0
fi

if [[ "$skip_build" == "0" ]]; then
  make build
fi

if [[ "$skip_test" == "0" ]]; then
  make test
fi

if [[ "$skip_swiftformat" == "0" ]]; then
  make format_check
fi

if [[ "$skip_swiftlint" == "0" ]]; then
  make lint
fi
