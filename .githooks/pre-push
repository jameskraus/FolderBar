#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

if [[ "${SKIP_SWIFTLINT:-}" == "1" || "${FOLDERBAR_SKIP_LINT:-}" == "1" ]]; then
  exit 0
fi

if ! command -v swiftlint >/dev/null 2>&1; then
  echo "SwiftLint is required for pre-push linting but was not found on PATH." >&2
  echo "Install: brew install swiftlint" >&2
  echo "Skip once: SKIP_SWIFTLINT=1 git push (or git push --no-verify)" >&2
  exit 1
fi

EMPTY_TREE="$(git hash-object -t tree /dev/null)"

tmpfile="$(mktemp)"
trap 'rm -f "$tmpfile"' EXIT

stdin=""
if [[ ! -t 0 ]]; then
  stdin="$(cat || true)"
fi

if [[ -n "$stdin" ]]; then
  while read -r local_ref local_sha remote_ref remote_sha; do
    if [[ -z "${local_sha}" ]]; then
      continue
    fi

    base_sha="$remote_sha"
    if [[ "${remote_sha}" =~ ^0+$ ]]; then
      base_sha="$EMPTY_TREE"
    fi

    git diff --name-only "$base_sha" "$local_sha" -- '*.swift' >>"$tmpfile" || true
  done <<<"$stdin"
else
  if git rev-parse --verify '@{u}' >/dev/null 2>&1; then
    upstream="$(git rev-parse '@{u}')"
    base_sha="$(git merge-base HEAD "$upstream")"
    git diff --name-only "$base_sha" HEAD -- '*.swift' >>"$tmpfile" || true
  else
    swiftlint lint --strict --config "$ROOT/.swiftlint.yml" --quiet --working-directory "$ROOT"
    exit $?
  fi
fi

if [[ ! -s "$tmpfile" ]]; then
  exit 0
fi

count="$(sort -u "$tmpfile" | wc -l | tr -d ' ')"
if [[ "$count" -gt 200 ]]; then
  swiftlint lint --strict --config "$ROOT/.swiftlint.yml" --quiet --working-directory "$ROOT"
  exit $?
fi

export SCRIPT_INPUT_FILE_COUNT="$count"
idx=0
while IFS= read -r path; do
  [[ -z "$path" ]] && continue
  export "SCRIPT_INPUT_FILE_${idx}=${ROOT}/${path}"
  idx=$((idx + 1))
done < <(sort -u "$tmpfile")

swiftlint lint \
  --strict \
  --config "$ROOT/.swiftlint.yml" \
  --quiet \
  --force-exclude \
  --use-script-input-files \
  --working-directory "$ROOT"
